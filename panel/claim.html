<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FeedOS™ — Verification</title>
  <link rel="icon" href="/assets/logo.png">
  <style>
    :root{
      --bg:#eef4ef; --card:#ffffff; --muted:#6a7c6f; --text:#1d2a22;
      --ok:#dff2e1; --ok-text:#23683d; --bad:#fde8e8; --bad-text:#8c2626;
      --btn:#2f6b49; --btn-hover:#285c3f; --pill:#e8efe8; --border:#e6ece7;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
    .container{ max-width:980px; margin:32px auto; padding:0 16px; }
    header{ display:flex; align-items:center; gap:12px; margin-bottom:16px; }
    header .brand{ display:flex; align-items:center; gap:10px; font-weight:700; font-size:18px; }
    header .brand img{ width:28px; height:28px; border-radius:6px }
    .card{ background:var(--card); border-radius:14px; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.04); border:1px solid var(--border); }
    .badge{ display:inline-block; padding:8px 12px; border-radius:999px; font-size:14px; font-weight:600; }
    .ok{ background:var(--ok); color:var(--ok-text) }
    .bad{ background:var(--bad); color:var(--bad-text) }
    .grid{ display:grid; grid-template-columns:240px 1fr; gap:24px; margin-top:16px; }
    .qr-box{ width:100%; aspect-ratio:1/1; border-radius:12px; background:#f5f7f5; display:flex; align-items:center; justify-content:center; border:1px dashed var(--border); overflow:hidden; }
    .kv{ line-height:1.9 } .kv dt{ font-weight:700 } .kv dd{ margin:0 0 8px 0; color:#2d3a32 }
    .row{ display:flex; flex-wrap:wrap; gap:10px; margin-top:18px }
    .btn{ appearance:none; border:0; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; background:var(--btn); color:#fff; }
    .btn.secondary{ background:#e9efe9; color:#1f2b24 } .btn:hover{ background:var(--btn-hover) } .btn.secondary:hover{ background:#dde6de }
    .footer-note{ color:var(--muted); margin-top:18px; font-size:14px; text-align:center }
    @media (max-width:800px){ .grid{ grid-template-columns:1fr; } }
    a.link{ color:#245e3d; text-decoration:underline; font-weight:600 }
    .checks{ margin-top:12px; padding-left:18px; line-height:1.8 }
    code.hash{ background:#f3f5f3; padding:2px 6px; border-radius:6px; font-size:12px }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand"><img src="/assets/logo.png" alt="logo"><span>FeedOS™ — Verification</span></div>
      <span id="sigBadge" class="badge" style="margin-left:8px;">Checking…</span>
      <div style="margin-left:auto"><a href="/" class="btn secondary">Home</a></div>
    </header>

    <div class="card">
      <div class="topbar" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div><b id="claimId">Claim sample-001</b></div>
        <span class="pill" style="background:var(--pill); padding:8px 12px; border-radius:999px; font-weight:600;">FCS — Demo</span>
      </div>

      <div class="grid">
        <div>
          <div class="qr-box"><img id="qrImg" alt="QR"/></div>
          <div class="row">
            <button id="verifyBtn" class="btn">Verify signature</button>
            <button id="tamperBtn" class="btn secondary">Simulate tamper</button>
            <button id="copyBtn" class="btn secondary">Copy Link</button>
          </div>
        </div>
        <div>
          <dl class="kv">
            <dt>Farm</dt><dd id="farm">–</dd>
            <dt>Batch</dt><dd id="batch">–</dd>
            <dt>Species</dt><dd id="species">–</dd>
            <dt>KPIs</dt><dd><span id="kpi">–</span></dd>
            <dt>Issued at</dt><dd id="issued">–</dd>
            <dt>Signature</dt><dd><code id="sig" class="hash">–</code></dd>
          </dl>
          <details style="margin-top:8px;">
            <summary><b>Open payload JSON</b></summary>
            <pre id="json" style="background:#f6f8f6; border:1px solid var(--border); padding:12px; border-radius:8px; overflow:auto; font-size:12px"></pre>
          </details>

          <div class="checks">
            <div id="c-int" class="muted">Canonical string present</div>
            <div id="c-sig" class="muted">Verifying signature…</div>
          </div>

          <p class="footer-note">We are <b>not</b> a certification authority. FeedOS produces verifiable digital evidence; official certification is issued by an accredited third party.</p>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);
  const qp = new URLSearchParams(location.search);
  const token = (qp.get('token') || 'sample-001').trim();
  const claimIdEl = $('claimId');

  function setBadge(ok, msg){
    const el = $('sigBadge');
    el.className = 'badge ' + (ok ? 'ok' : 'bad');
    el.textContent = msg;
  }

  async function loadClaim(){
    claimIdEl.textContent = `Claim ${token}`;
    const url = `/api/verify?id=${encodeURIComponent(token)}`;
    const r = await fetch(url);
    if(!r.ok){ setBadge(false, 'Not found'); return; }
    const j = await r.json();
    $('farm').textContent = j.payload.farm_id;
    $('batch').textContent = j.payload.batch_id;
    $('species').textContent = j.payload.species;
    $('kpi').textContent = `FCR: ${j.payload.feed_conversion} | NH3: ${j.payload.ammonia_ppm}ppm | CO₂: ${j.payload.co2_ppm}ppm`;
    $('issued').textContent = j.meta?.issued_at || '—';
    $('sig').textContent = (j.signature || '').slice(0,16) + '…';
    $('json').textContent = JSON.stringify(j.payload, null, 2);

    // QR لینک به همین صفحه
    const qrData = location.origin + `/claim?token=${encodeURIComponent(token)}`;
    $('qrImg').src = `https://api.qrserver.com/v1/create-qr-code/?size=480x480&data=${encodeURIComponent(qrData)}`;
  }

  async function verify(){
    const r = await fetch(`/api/verify?mode=verify&id=${encodeURIComponent(token)}`);
    const j = await r.json();
    if(j.valid){ setBadge(true, 'Valid — signature OK'); document.getElementById('c-sig').textContent = 'Signature valid'; }
    else      { setBadge(false,'Invalid — signature mismatch'); document.getElementById('c-sig').textContent = 'Signature invalid'; }
  }

  function simulateTamper(){
    setBadge(false, 'Invalid — payload tampered');
    document.getElementById('c-sig').textContent = 'Signature invalid (tamper demo)';
  }

  async function copyLink(){
    try{
      await navigator.clipboard.writeText(location.href);
      document.getElementById('copyBtn').textContent = 'Copied!';
      setTimeout(()=> document.getElementById('copyBtn').textContent='Copy Link', 1200);
    }catch{ alert('Copy failed — copy the URL.'); }
  }

  document.getElementById('verifyBtn').addEventListener('click', verify);
  document.getElementById('tamperBtn').addEventListener('click', simulateTamper);
  document.getElementById('copyBtn').addEventListener('click', copyLink);

  loadClaim();
</script>
</body>
</html>
