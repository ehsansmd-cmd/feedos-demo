<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FeedOS™ — Verification</title>
  <link rel="icon" href="../assets/logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    :root{--green:#204F32;--bg:#eef3ef}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Ubuntu,Arial}
    .wrap{max-width:900px;margin:28px auto;padding:0 16px}
    .card{background:#fff;border-radius:18px;box-shadow:0 4px 20px rgba(0,0,0,.06);padding:22px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:10px;color:var(--green);font-weight:800}
    .brand img{width:26px;height:26px;border-radius:6px}
    .status{display:inline-block;border-radius:999px;padding:7px 10px;font-size:12px;margin-top:8px}
    .ok{background:#e6f4ea;color:#1a7f41}
    .bad{background:#fde8e8;color:#b42318}
    .row{display:grid;grid-template-columns:260px 1fr;gap:24px}
    .btn{background:#e7efe9;color:#204F32;border:0;border-radius:10px;padding:10px 12px;font-weight:700;margin-right:8px;cursor:pointer}
    .btn.primary{background:#204F32;color:#fff}
    .back{margin-top:16px;color:#204F32}
    .muted{color:#5c6b62}
    code{background:#f4f5f7;border-radius:8px;padding:3px 6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div class="brand"><img src="../assets/logo.png" alt="logo"> <span>FeedOS™ — Verification</span></div>
        <button class="btn" onclick="location.href='/panel'">Back to panel</button>
      </header>

      <div id="statusBox"></div>

      <p class="muted">Scan the QR or open the JSON to validate this claim token.</p>

      <div class="row" style="margin-top:14px">
        <canvas id="qrc" width="240" height="240" style="background:#fff;border-radius:12px"></canvas>
        <div id="details"></div>
      </div>

      <div style="margin-top:16px">
        <button id="tamper" class="btn">Simulate Tamper</button>
        <button id="download" class="btn">Download JSON</button>
        <button id="copy" class="btn">Copy Link</button>
        <a id="raw" class="btn" target="_blank">View raw dossier</a>
      </div>

      <div class="muted" style="margin-top:16px">FeedOS Claim Standard (FCS™) — digitally signed mock certificate for demonstration purposes. Demo — data are simulated.</div>
    </div>
  </div>

  <script>
    // Simple auth gate (optional – می‌تونی برداری اگر نمی‌خوای الزام لاگین داشته باشه)
    if (localStorage.getItem('feedos_auth') !== 'ok') {
      window.location.href = '/login';
    }

    const qs = new URLSearchParams(location.search);
    const token = qs.get('token') || localStorage.getItem('feedos_selected_token');
    if(!token){ alert('Missing token'); location.href='/panel'; }

    const $ = s => document.querySelector(s);

    async function loadBatchByToken(tok){
      const r = await fetch('/data/batches.json');
      const j = await r.json();
      return (j.batches||[]).find(b => b.token===tok);
    }

    async function load(){
      const b = await loadBatchByToken(token);
      if(!b){ alert('Unknown token'); location.href='/panel'; return; }

      // Load dossier
      const r = await fetch('/'+b.dossier_json);
      if(!r.ok){ alert('Cannot load dossier'); return; }
      const d = await r.json();

      // Status
      const ok = !!d.valid_signature;
      $('#statusBox').innerHTML =
        `<span class="status ${ok?'ok':'bad'}">${ok?'Signature Valid — Machine-verifiable claim':'Signature Invalid — Signature Mismatch'}</span>`;

      // QR
      const qrLink = `${location.origin}/panel/claim.html?token=${encodeURIComponent(token)}`;
      const canvas = $('#qrc');
      await QRCode.toCanvas(canvas, qrLink, {margin:1,width:240});

      // Details
      const lines = [
        ['Batch:', d.batch_id],
        ['Nutrient Target:', d.nutrient_target],
        ['Verified Result:', d.verified_result + (ok ? '' : ' (Tampered)')],
        ['CO₂e Summary:', d.co2_summary],
        ['EFSA Ref:', d.efsa_claim_ref],
        ['Issued at:', d.issued_at],
        ['Signer:', d.signer]
      ].map(([k,v])=>`<p><b>${k}</b> ${v}</p>`).join('');

      $('#details').innerHTML = `
        ${lines}
        <p>API: <a href="/${b.dossier_json}" target="_blank">Open JSON</a></p>
        <p>Signature: <code>${d.signature}</code></p>
      `;

      // Buttons
      $('#raw').href = '/'+b.dossier_json;
      $('#copy').onclick = async ()=>{ await navigator.clipboard.writeText(qrLink); alert('Link copied'); };

      // Tamper simulation: فقط متن result را دستکاری می‌کنیم (سمت کلاینت)
      let tampered = false;
      $('#tamper').onclick = ()=>{
        tampered = !tampered;
        const el = $('#details');
        if(tampered){
          el.innerHTML = el.innerHTML.replace(d.verified_result, '999 mg/egg');
          $('#statusBox').innerHTML = `<span class="status bad">Signature Invalid — Signature Mismatch</span>`;
          $('#tamper').textContent = 'Revert';
        }else{
          load(); // ری‌لود امن
        }
      };

      // Download JSON
      $('#download').onclick = ()=>{
        const a=document.createElement('a');
        a.href='/'+b.dossier_json; a.download=b.dossier_json.split('/').pop();
        a.click();
      };
    }
    load();
  </script>
</body>
</html>
