<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FeedOS™ — Panel Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="../assets/logo.png" />
  <style>
    :root{
      --brand:#204F32; --accent:#8BF35A; --ink:#22302A; --muted:#5A6B62; --bg:#F4F7F5; --card:#ffffff;
    }
    *{box-sizing:border-box} body{margin:0;background:#eef3ef;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .nav{display:flex;align-items:center;gap:12px}
    .logo{display:flex;align-items:center;gap:10px}
    .logo img{width:34px;height:34px;border-radius:7px}
    .brand{font-weight:700;font-size:24px;color:var(--brand)}
    .sub{color:#6b7a71;font-size:13px;margin-top:-6px}
    .right{margin-left:auto;display:flex;gap:10px}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.ghost{background:#e6eee9;color:var(--brand)}
    .btn.red{background:#385243}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-top:18px}
    .kpi{background:#fff;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:18px;text-align:center}
    .kpi h4{margin:0 0 6px 0;font-size:16px;color:#375244}
    .kpi .val{font-size:26px;font-weight:800;color:#1e342a}
    .cards{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.06);padding:16px;min-height:260px}
    .card h3{margin:6px 0 8px 0;color:#1f3a2e}
    .badge{background:#eaf2ed;color:#355c46;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:600;float:right}
    footer{margin:24px 0 10px 0;color:#6a7a71;font-size:12px;text-align:center}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <!-- Top bar -->
    <div class="nav">
      <div class="logo">
        <img src="../assets/logo.png" alt="FeedOS logo" />
        <div>
          <div class="brand">FeedOS™</div>
          <div class="sub">The AI Platform for Sustainable Protein Farming</div>
        </div>
      </div>
      <div class="right">
        <button class="btn ghost" id="qrBtn">View QR Outcome</button>
        <button class="btn ghost" id="apiBtn">View JSON API</button>
        <button class="btn" id="logoutBtn">Logout</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid">
      <div class="kpi">
        <h4>Current Batch</h4>
        <div class="val" id="batchVal">FEG-2026-001</div>
      </div>
      <div class="kpi">
        <h4>Uptime (24h)</h4>
        <div class="val" id="uptimeVal">99.8%</div>
      </div>
      <div class="kpi">
        <h4>Avg CO₂ (ppm)</h4>
        <div class="val" id="co2AvgVal">953</div>
      </div>
      <div class="kpi">
        <h4>NH₃ Peak (ppm)</h4>
        <div class="val" id="nh3PeakVal">9.1</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="cards">
      <div class="card">
        <h3>Temperature (°C) <span class="badge">Sensor: dev-001</span></h3>
        <canvas id="tempChart" height="120"></canvas>
      </div>
      <div class="card">
        <h3>Relative Humidity (%) <span class="badge">Sensor: dev-001</span></h3>
        <canvas id="rhChart" height="120"></canvas>
      </div>
      <div class="card">
        <h3>Ammonia NH₃ (ppm) <span class="badge">Sensor: dev-001</span></h3>
        <canvas id="nh3Chart" height="120"></canvas>
      </div>
      <div class="card">
        <h3>CO₂ (ppm) <span class="badge">Sensor: dev-001</span></h3>
        <canvas id="co2Chart" height="120"></canvas>
      </div>
    </div>

    <footer>Demo for Business Finland — data are simulated.</footer>
  </div>

<script>
/* -------------------- auth gate -------------------- */
(function authGate(){
  try{
    const ok = localStorage.getItem('feedos_auth');
    if(ok !== 'ok'){ window.location.href = '/login'; }
  }catch(e){ window.location.href = '/login'; }
})();

/* -------------------- helpers -------------------- */
const $ = (id)=>document.getElementById(id);
const JSON_URL = '../data/mock_telemetry.json'; // از روت می‌خونه

// جلوگیری از کش شدن JSON
async function loadJSON() {
  const url = JSON_URL + '?t=' + Date.now();
  const res = await fetch(url, { cache: 'no-store' });
  if(!res.ok) throw new Error('Failed to load telemetry');
  return res.json();
}

function jitter(val, pct=0.01){ // ±1%
  const delta = val * pct;
  const rnd = (Math.random()*2 - 1) * delta;
  return Math.max(0, Math.round((val + rnd)*10)/10);
}

/* -------------------- charts -------------------- */
let tempChart, rhChart, nh3Chart, co2Chart;

function buildLine(ctx, label, data){
  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map((_,i)=>String(i+1)),
      datasets: [{
        label,
        data,
        borderWidth: 2,
        tension: 0.3,
        pointRadius: 3,
        borderColor: '#2E7D50',
        backgroundColor: 'rgba(46,125,80,0.15)'
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ display:false } },
      scales:{ y:{ beginAtZero:false } }
    }
  });
}

function updateChart(chart, data){
  chart.data.labels = data.map((_,i)=>String(i+1));
  chart.data.datasets[0].data = data;
  chart.update();
}

/* -------------------- UI actions -------------------- */
$('logoutBtn').onclick = ()=>{ localStorage.removeItem('feedos_auth'); window.location.href = '/login'; };
$('qrBtn').onclick = ()=>{ window.location.href = '/panel/claim.html?token=clm_demo_001'; };
$('apiBtn').onclick = ()=>{ window.location.href = '/dossier/claim_clm_demo_001.json'; };

/* -------------------- initial load -------------------- */
let state = null;

async function init(){
  try{
    state = await loadJSON();

    // KPIs
    $('batchVal').textContent = 'FEG-2026-001';
    $('uptimeVal').textContent = '99.8%';

    // average CO2 از داده‌ها محاسبه می‌شود
    const co2 = state.series.co2;
    const nh3 = state.series.nh3;

    const avgCO2 = Math.round(co2.reduce((a,b)=>a+b,0)/co2.length);
    const peakNH3 = Math.max(...nh3);

    $('co2AvgVal').textContent = String(avgCO2);
    $('nh3PeakVal').textContent = String(peakNH3);

    // Charts
    tempChart = buildLine($('tempChart'), 'Temp', state.series.temperature);
    rhChart   = buildLine($('rhChart'),   'RH',   state.series.humidity);
    nh3Chart  = buildLine($('nh3Chart'),  'NH3',  nh3);
    co2Chart  = buildLine($('co2Chart'),  'CO2',  co2);

  }catch(err){
    console.error(err);
    alert('Could not load telemetry. Check data/mock_telemetry.json');
  }
}

/* -------------------- periodic refresh -------------------- */
async function refreshLoop(){
  try{
    const data = await loadJSON();   // no-store + cache-bust => همیشه تازه
    // کمی نوسان برای حس زنده بودن
    const co2Avg = Math.round(data.series.co2.reduce((a,b)=>a+b,0)/data.series.co2.length);
    const nh3Pk  = Math.max(...data.series.nh3);

    $('co2AvgVal').textContent = String(jitter(co2Avg, 0.02));
    $('nh3PeakVal').textContent = String(jitter(nh3Pk, 0.02));

    updateChart(tempChart, data.series.temperature.map(v=>jitter(v,0.01)));
    updateChart(rhChart,   data.series.humidity.map(v=>jitter(v,0.01)));
    updateChart(nh3Chart,  data.series.nh3.map(v=>jitter(v,0.02)));
    updateChart(co2Chart,  data.series.co2.map(v=>jitter(v,0.02)));
  }catch(e){
    console.warn('refresh failed', e);
  }finally{
    setTimeout(refreshLoop, 7000); // هر ۷ ثانیه
  }
}

init().then(refreshLoop);
</script>
</body>
</html>
