<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FeedOS™ — Panel Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --green:#204F32; --green-2:#2E7D50; --accent:#8BF35A;
      --text:#22302A; --muted:#5A6B62; --bg:#F4F7F5; --card:#ffffff;
      --line:#2E7D50;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#eef3ef;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text)}
    .wrap{max-width:1120px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#fff;border-radius:14px;margin-bottom:16px;box-shadow:0 1px 0 rgba(0,0,0,.04)}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:32px;height:32px;border-radius:8px}
    .brand h1{font-size:20px;margin:0;color:var(--green)}
    .navbtns{display:flex;gap:10px;align-items:center}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid rgba(0,0,0,.08);background:#e8f1eb;color:#0f3; color:var(--green);font-weight:600;text-decoration:none}
    .btn.primary{background:var(--green);color:#fff;border-color:var(--green)}
    .btn.ghost{background:#fff}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    .kpi{background:#fff;border-radius:16px;padding:18px 16px;text-align:center;font-weight:700;box-shadow:0 2px 0 rgba(0,0,0,.04)}
    .kpi small{display:block;font-weight:600;color:var(--muted);margin-bottom:6px}
    .cards{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 2px 0 rgba(0,0,0,.04)}
    .card h3{margin:0 0 10px 0;color:var(--green);font-size:18px}
    canvas{width:100%;height:260px;display:block}
    footer{margin:22px auto 40px;max-width:1120px;color:var(--muted);font-size:14px;text-align:center}
    @media (max-width:900px){
      .grid{grid-template-columns:1fr 1fr}
      .cards{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <script>
    // Gate: اگر لاگین نکرده بود، بفرست به /login
    (function(){
      try{
        if(localStorage.getItem('feedos_auth')!=='ok'){
          location.replace('/login');
        }
      }catch(e){}
    })();
  </script>

  <div class="wrap">
    <header>
      <div class="brand">
        <img src="/assets/logo.png" alt="FeedOS logo">
        <div>
          <h1>FeedOS™</h1>
          <div style="color:var(--muted);font-size:13px">The AI Platform for Sustainable Protein Farming</div>
        </div>
      </div>
      <div class="navbtns">
        <a class="btn" href="/panel/claim.html?token=clm_demo_001">View QR Outcome</a>
        <a class="btn ghost" href="/dossier/claim_clm_demo_001.json" target="_blank" rel="noopener">View JSON API</a>
        <button id="logoutBtn" class="btn primary" type="button">Logout</button>
      </div>
    </header>

    <section class="grid" id="kpis">
      <div class="kpi"><small>Current Batch</small><div id="batch">FEG-2026-001</div></div>
      <div class="kpi"><small>Uptime (24h)</small><div id="uptime">99.8%</div></div>
      <div class="kpi"><small>Avg CO₂ (ppm)</small><div id="co2Avg">–</div></div>
      <div class="kpi"><small>NH₃ Peak (ppm)</small><div id="nh3Peak">–</div></div>
    </section>

    <section class="cards">
      <div class="card">
        <h3>Temperature (°C)</h3>
        <canvas id="tempChart" width="800" height="260"></canvas>
      </div>
      <div class="card">
        <h3>Relative Humidity (%)</h3>
        <canvas id="rhChart" width="800" height="260"></canvas>
      </div>
      <div class="card">
        <h3>Ammonia NH₃ (ppm)</h3>
        <canvas id="nh3Chart" width="800" height="260"></canvas>
      </div>
      <div class="card">
        <h3>CO₂ (ppm)</h3>
        <canvas id="co2Chart" width="800" height="260"></canvas>
      </div>
    </section>
  </div>

  <footer>Demo for Business Finland — data are simulated.</footer>

  <script>
    // ساده‌ترین رسم خطی روی canvas
    function drawLine(canvas, series){
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);
      const pad = 28;
      const xs = series.map((_,i)=>i);
      const min = Math.min(...series), max = Math.max(...series);
      const ax = (x)=> pad + (x/(series.length-1))*(w-2*pad);
      const ay = (y)=> h-pad - ((y-min)/(max-min||1))*(h-2*pad);

      // axes
      ctx.strokeStyle = 'rgba(0,0,0,.08)';
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, h-pad); ctx.lineTo(w-pad, h-pad); ctx.stroke();

      // line
      ctx.strokeStyle = '#2E7D50';
      ctx.lineWidth = 2;
      ctx.beginPath();
      xs.forEach((x,i)=>{
        const X=ax(x), Y=ay(series[i]);
        if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
      });
      ctx.stroke();

      // dots
      ctx.fillStyle = '#2E7D50';
      xs.forEach((x,i)=>{
        const X=ax(x), Y=ay(series[i]);
        ctx.beginPath(); ctx.arc(X,Y,3,0,Math.PI*2); ctx.fill();
      });
    }

    // داده نمونه fallback
    const FALLBACK = {
      temperature: [21.1,21.3,20.9,20.8,21.7,21.9,21.5,20.8],
      humidity:    [56.8,57.1,55.9,56.2,55.7,57.3,56.5,55.0],
      nh3:         [7.6,8.9,7.2,8.6,7.9,8.4,8.0,7.3],
      co2:         [910,1008,860,1035,985,940,990,905]
    };

    const els = {
      co2Avg: document.getElementById('co2Avg'),
      nh3Peak: document.getElementById('nh3Peak'),
      t: document.getElementById('tempChart'),
      rh: document.getElementById('rhChart'),
      nh3: document.getElementById('nh3Chart'),
      co2: document.getElementById('co2Chart'),
    };

    async function loadData(){
      try{
        const res = await fetch('/data/mock_telemetry.json?t=' + Date.now(), {cache:'no-store'});
        if(!res.ok) throw new Error('fetch failed');
        const json = await res.json();
        return {
          temperature: json.temperature ?? FALLBACK.temperature,
          humidity:    json.humidity ?? FALLBACK.humidity,
          nh3:         json.nh3 ?? FALLBACK.nh3,
          co2:         json.co2 ?? FALLBACK.co2,
        };
      }catch(e){
        // اگر خطا، از داده‌ی نمونه استفاده کن
        return {...FALLBACK};
      }
    }

    function setKPIs(data){
      const avg = (arr)=> Math.round(arr.reduce((a,b)=>a+b,0)/arr.length);
      const peak = (arr)=> Math.max(...arr).toFixed(1);
      els.co2Avg.textContent = String(avg(data.co2));
      els.nh3Peak.textContent = String(peak(data.nh3));
    }

    async function render(){
      const d = await loadData();
      setKPIs(d);
      drawLine(els.t,  d.temperature);
      drawLine(els.rh, d.humidity);
      drawLine(els.nh3,d.nh3);
      drawLine(els.co2,d.co2);
    }

    // اولین رندر و آپدیت‌های دوره‌ای
    render();
    setInterval(async ()=>{
      await render();
    }, 7000);

    // logout
    document.getElementById('logoutBtn').addEventListener('click', ()=>{
      try{ localStorage.removeItem('feedos_auth'); }catch(e){}
      location.href = '/login';
    });
  </script>
</body>
</html>
