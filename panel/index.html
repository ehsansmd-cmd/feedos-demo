<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FeedOS™ — Panel Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="/assets/logo.png"/>
<style>
:root{--primary:#204F32;--secondary:#2E7D50;--text:#22302A;--muted:#5A6B62;--bg:#F4F7F5;--border:#e5eee9;--shadow:0 8px 30px rgba(0,0,0,.06)}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text)}
.container{max-width:1100px;margin:0 auto;padding:0 20px}
header{background:#fff;border-bottom:1px solid var(--border)}
nav{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
.brand{display:flex;align-items:center;gap:10px}
.brand img{width:36px;height:36px;border-radius:10px}
.brand .name{font-family:'EB Garamond',serif;font-weight:700;font-size:22px;color:var(--primary)}
.action a,.action button{margin-left:12px;background:var(--secondary);color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none;font-weight:700;border:0;cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin:20px 0}
.card{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:10px}
.kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;font-weight:700}
footer{margin:18px 0 14px;text-align:center;color:var(--muted);font-size:12px}
canvas{width:100%;height:280px}
@media (max-width:900px){.grid{grid-template-columns:1fr}.kpis{grid-template-columns:repeat(2,1fr)}}
</style>
<script>
// --- guard: require demo login
(function(){
  if (sessionStorage.getItem('feedos_auth') !== '1') {
    location.replace('/login.html?next=' + encodeURIComponent(location.pathname));
  }
})();
</script>
</head>
<body>
<header>
  <div class="container">
    <nav>
      <div class="brand"><img src="/assets/logo.png" alt="logo"><div class="name">FeedOS™</div></div>
      <div class="action">
        <a href="/panel/claim.html?token=clm_demo_001">View QR Outcome</a>
        <a href="/dossier/claim_clm_demo_001.json">View JSON API</a>
        <button onclick="sessionStorage.removeItem('feedos_auth');location.href='/'">Logout</button>
      </div>
    </nav>
  </div>
</header>

<main class="container">
  <div class="kpis">
    <div class="kpi">Current Batch<br><span id="batch">FEG-2026-001</span></div>
    <div class="kpi">Uptime (24h)<br><span id="uptime">99.8%</span></div>
    <div class="kpi">Avg CO₂ (ppm)<br><span id="co2">953</span></div>
    <div class="kpi">NH₃ Peak (ppm)<br><span id="nh3p">9.1</span></div>
  </div>

  <div class="grid">
    <div class="card"><h3>Temperature (°C)</h3><canvas id="tChart"></canvas></div>
    <div class="card"><h3>Relative Humidity (%)</h3><canvas id="hChart"></canvas></div>
    <div class="card"><h3>Ammonia NH₃ (ppm)</h3><canvas id="nChart"></canvas></div>
    <div class="card"><h3>CO₂ (ppm)</h3><canvas id="cChart"></canvas></div>
  </div>

  <div class="card">
    <h3>About this Panel</h3>
    <ol>
      <li><b>Edge/Cloud Telemetry (mock)</b>: reads from <code>/data/mock_telemetry.json</code></li>
      <li><b>Outcome Dossier (FCS™)</b>: <code>/dossier/claim_clm_demo_001.json</code></li>
      <li><b>Verification UI</b>: QR page renders batch details & validity.</li>
    </ol>
  </div>
</main>

<footer>Demo for Business Finland — data simulated from mock telemetry.</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// fetch mock data every few seconds
async function fetchTelemetry(){
  try {
    const res = await fetch('/mock_telemetry.json?_=' + Date.now());
    const js = await res.json();
    updateTelemetry(js);
  } catch(err){ console.error('Fetch failed',err); }
}

function updateTelemetry(js){
  document.getElementById('batch').textContent = js.batch_id;
  const c = avg(js.sensors.co2);
  const n = Math.max(...js.sensors.nh3);
  document.getElementById('co2').textContent  = c.toFixed(0);
  document.getElementById('nh3p').textContent = n.toFixed(1);
  drawChart('tChart',js.sensors.temperature);
  drawChart('hChart',js.sensors.humidity);
  drawChart('nChart',js.sensors.nh3);
  drawChart('cChart',js.sensors.co2);
}

function avg(a){return a.reduce((x,y)=>x+y)/a.length}
function drawChart(id,data){
  new Chart(document.getElementById(id).getContext('2d'),{
    type:'line',data:{labels:data.map((_,i)=>i+1),datasets:[{data,fill:false,borderColor:'#204F32'}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:false}}}
  });
}

fetchTelemetry();
setInterval(fetchTelemetry, 7000); // هر ۷ ثانیه داده جدید

</script>
</body>
</html>
